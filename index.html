<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weight & Calorie Tracker</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 1rem;
    background: #f5f7fa;
    color: #222;
  }
  h1, h2 {
    text-align: center;
  }
  .date-nav {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0;
  }
  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    background-color: #4caf50;
    border: none;
    color: white;
    border-radius: 6px;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #45a049;
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  input[type=number] {
    font-size: 1rem;
    padding: 0.3rem 0.5rem;
    width: 100px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  label {
    font-weight: 600;
  }
  .field-group {
    margin: 1rem 0;
    display: flex;
    justify-content: center;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  .result {
    text-align: center;
    margin-top: 2rem;
    font-size: 1.2rem;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 5px #ccc;
  }
  footer {
    text-align: center;
    margin-top: 3rem;
    font-size: 0.8rem;
    color: #666;
  }
  #chart-container {
    margin: 2rem auto;
    max-width: 500px;
  }
</style>
</head>
<body>

<h1>Weight & Calorie Tracker</h1>

<div class="date-nav">
  <button id="prev-day">&lt; Prev</button>
  <div id="date-display" aria-live="polite" style="min-width: 140px; text-align:center;"></div>
  <button id="next-day">Next &gt;</button>
</div>

<div class="field-group">
  <label for="weight-input">Weight (kg):</label>
  <input type="number" id="weight-input" min="30" max="300" step="0.1" />
  <button id="save-weight">Save</button>
</div>

<div class="field-group">
  <label for="weekly-target">Target weight loss per week (kg):</label>
  <input type="number" id="weekly-target" min="0" max="5" step="0.1" />
  <button id="save-target">Save</button>
</div>

<div class="field-group">
  <label for="calories-input">Calories:</label>
  <input type="number" id="calories-input" min="1200" max="6000" step="50" />
  <button id="save-calories">Save</button>
</div>

<div class="result" id="calorie-result">
  Set your weight and target to see your calorie recommendation.
</div>

<div id="chart-container">
  <h2>Weight History (Last 30 days)</h2>
  <canvas id="weight-chart" width="500" height="250"></canvas>
</div>

<footer>Data is saved locally on your device.</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Utility functions ---
  function formatDate(date) {
    return date.toISOString().slice(0, 10); // "YYYY-MM-DD"
  }

  function parseDate(str) {
    return new Date(str + 'T00:00:00');
  }

  // --- Constants and Storage Keys ---
  const STORAGE_KEYS = {
    weights: 'weightData',
    weeklyTarget: 'weeklyWeightLossTarget',
    caloriesData: 'caloriesData', // calories per day storage
  };

  // Default starting calories if none set
  const DEFAULT_CALORIES = 3200;

  // --- State ---
  let selectedDate = new Date();
  selectedDate.setHours(0,0,0,0);

  // Load data from localStorage or init
  let weightData = JSON.parse(localStorage.getItem(STORAGE_KEYS.weights)) || {};
  let weeklyTarget = parseFloat(localStorage.getItem(STORAGE_KEYS.weeklyTarget)) || 0;
  let caloriesData = JSON.parse(localStorage.getItem(STORAGE_KEYS.caloriesData)) || {};

  // --- Elements ---
  const dateDisplay = document.getElementById('date-display');
  const prevBtn = document.getElementById('prev-day');
  const nextBtn = document.getElementById('next-day');
  const weightInput = document.getElementById('weight-input');
  const saveWeightBtn = document.getElementById('save-weight');
  const weeklyTargetInput = document.getElementById('weekly-target');
  const saveTargetBtn = document.getElementById('save-target');
  const caloriesInput = document.getElementById('calories-input');
  const saveCaloriesBtn = document.getElementById('save-calories');
  const calorieResult = document.getElementById('calorie-result');
  const chartCtx = document.getElementById('weight-chart').getContext('2d');

  // --- Functions ---
  function saveAll() {
    localStorage.setItem(STORAGE_KEYS.weights, JSON.stringify(weightData));
    localStorage.setItem(STORAGE_KEYS.weeklyTarget, weeklyTarget.toString());
    localStorage.setItem(STORAGE_KEYS.caloriesData, JSON.stringify(caloriesData));
  }

  function updateDateDisplay() {
    dateDisplay.textContent = selectedDate.toDateString();
  }

  function loadWeightForDate(date) {
    const key = formatDate(date);
    return weightData[key] || null;
  }

  function saveWeightForDate(date, weight) {
    const key = formatDate(date);
    if (weight === null || weight === '') {
      delete weightData[key];
    } else {
      weightData[key] = weight;
    }
    saveAll();
  }

  function loadCaloriesForDate(date) {
    const key = formatDate(date);
    return caloriesData[key] || null;
  }

  function saveCaloriesForDate(date, calories) {
    const key = formatDate(date);
    if (calories === null || calories === '') {
      delete caloriesData[key];
    } else {
      caloriesData[key] = calories;
    }
    saveAll();
  }

  function getDateNDaysBefore(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() - n);
    return d;
  }

  // Calculate calories for a date by checking 7 days ago weight change and previous calories
  function calculateCalories(date) {
    const todayKey = formatDate(date);
    const oldDate = getDateNDaysBefore(date, 7);
    const oldKey = formatDate(oldDate);

    const W_old = weightData[oldKey];
    const W_new = weightData[todayKey];
    const targetLoss = weeklyTarget || 0;

    if (W_old == null || W_new == null) {
      return "Enter weight for today and 7 days ago to calculate calories.";
    }

    // Get previous day calories to base adjustment on (or default)
    const prevDate = getDateNDaysBefore(date, 1);
    const prevKey = formatDate(prevDate);
    let prevCalories = caloriesData[prevKey] || DEFAULT_CALORIES;

    const actualLoss = W_old - W_new;

    let newCalories = prevCalories;

    if (actualLoss < targetLoss) {
      // Reduce calories by 500 but no lower than 1200
      newCalories = Math.max(1200, prevCalories - 500);
      saveCaloriesForDate(date, newCalories);
      return `Weight loss target not met. Calories reduced by 500 to ${newCalories} kcal/day for today.`;
    } else {
      // Target met, keep previous or default calories
      if (caloriesData[todayKey] !== prevCalories) {
        // Reset calories to prevCalories (or default)
        saveCaloriesForDate(date, prevCalories);
      }
      return `Weight loss target met! Maintain ${newCalories} kcal/day for today.`;
    }
  }

  // Update chart data and redraw
  let weightChart;

  function updateChart() {
    const dates = [];
    const weights = [];
    const today = new Date();
    today.setHours(0,0,0,0);

    for(let i = 29; i >= 0; i--) {
      let d = new Date(today);
      d.setDate(d.getDate() - i);
      let key = formatDate(d);
      dates.push(key);
      weights.push(weightData[key] || null);
    }

    if(weightChart) {
      weightChart.data.labels = dates;
      weightChart.data.datasets[0].data = weights;
      weightChart.update();
    } else {
      weightChart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Weight (kg)',
            data: weights,
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76,175,80,0.2)',
            spanGaps: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              min: Math.min(...weights.filter(w => w !== null)) - 2 || 30,
              max: Math.max(...weights.filter(w => w !== null)) + 2 || 120
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }
  }

  // Update UI weight input, calories input & calorie text for selectedDate
  function updateUI() {
    updateDateDisplay();
    const weightToday = loadWeightForDate(selectedDate);
    weightInput.value = weightToday !== null ? weightToday : '';

    weeklyTargetInput.value = weeklyTarget !== null ? weeklyTarget : '';
    const calToday = loadCaloriesForDate(selectedDate);
    caloriesInput.value = calToday !== null ? calToday : DEFAULT_CALORIES;

    calorieResult.textContent = calculateCalories(selectedDate);
    updateChart();
  }

  // --- Event Listeners ---
  prevBtn.onclick = () => {
    selectedDate.setDate(selectedDate.getDate() - 1);
    updateUI();
  };
  nextBtn.onclick = () => {
    selectedDate.setDate(selectedDate.getDate() + 1);
    updateUI();
  };

  saveWeightBtn.onclick = () => {
    let val = parseFloat(weightInput.value);
    if (isNaN(val) || val <= 0) {
      alert('Please enter a valid weight.');
      return;
    }
    saveWeightForDate(selectedDate, val);
    updateUI();
  };

  saveTargetBtn.onclick = () => {
    let val = parseFloat(weeklyTargetInput.value);
    if (isNaN(val) || val < 0) {
      alert('Please enter a valid target weight loss (>=0).');
      return;
    }
    weeklyTarget = val;
    localStorage.setItem(STORAGE_KEYS.weeklyTarget, weeklyTarget.toString());
    updateUI();
  };

  saveCaloriesBtn.onclick = () => {
    let val = parseInt(caloriesInput.value);
    if (isNaN(val) || val < 1200) {
      alert('Please enter a valid calorie number (>=1200).');
      return;
    }
    saveCaloriesForDate(selectedDate, val);
    updateUI();
  };

  // Init UI on load
  updateUI();
</script>
</body>
</html>
