<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weight & Calorie Tracker</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 1rem;
    background: #f5f7fa;
    color: #222;
  }
  h1, h2 {
    text-align: center;
  }
  .date-nav {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0;
  }
  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    background-color: #4caf50;
    border: none;
    color: white;
    border-radius: 6px;
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  input[type=number] {
    font-size: 1rem;
    padding: 0.3rem 0.5rem;
    width: 100px;
  }
  label {
    font-weight: 600;
  }
  .field-group {
    margin: 1rem 0;
    display: flex;
    justify-content: center;
    gap: 1rem;
    align-items: center;
  }
  .result {
    text-align: center;
    margin-top: 2rem;
    font-size: 1.2rem;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 5px #ccc;
  }
  footer {
    text-align: center;
    margin-top: 3rem;
    font-size: 0.8rem;
    color: #666;
  }
</style>
</head>
<body>

<h1>Weight & Calorie Tracker</h1>

<div class="date-nav">
  <button id="prev-day">&lt; Prev</button>
  <div id="date-display" aria-live="polite" style="min-width: 140px; text-align:center;"></div>
  <button id="next-day">Next &gt;</button>
</div>

<div class="field-group">
  <label for="weight-input">Weight (kg):</label>
  <input type="number" id="weight-input" min="30" max="300" step="0.1" />
  <button id="save-weight">Save</button>
</div>

<div class="field-group">
  <label for="weekly-target">Target weight loss per week (kg):</label>
  <input type="number" id="weekly-target" min="0" max="5" step="0.1" />
  <button id="save-target">Save</button>
</div>

<div class="result" id="calorie-result">
  Set your weight and target to see your calorie recommendation.
</div>

<footer>Data is saved locally on your device.</footer>

<script>
  // --- Utility functions ---
  function formatDate(date) {
    return date.toISOString().slice(0, 10); // "YYYY-MM-DD"
  }

  function parseDate(str) {
    return new Date(str + 'T00:00:00');
  }

  // --- Constants and Storage Keys ---
  const STORAGE_KEYS = {
    weights: 'weightData',
    weeklyTarget: 'weeklyWeightLossTarget',
    baseCalories: 'baseCalories', // default base calories (e.g. 3200)
  };

  // Default base calories (you can let user change this later)
  const DEFAULT_BASE_CALORIES = 3200;

  // --- State ---
  let selectedDate = new Date();
  selectedDate.setHours(0,0,0,0);

  // Load data from localStorage or init
  let weightData = JSON.parse(localStorage.getItem(STORAGE_KEYS.weights)) || {};
  let weeklyTarget = parseFloat(localStorage.getItem(STORAGE_KEYS.weeklyTarget)) || 0;
  let baseCalories = parseInt(localStorage.getItem(STORAGE_KEYS.baseCalories)) || DEFAULT_BASE_CALORIES;

  // --- Elements ---
  const dateDisplay = document.getElementById('date-display');
  const prevBtn = document.getElementById('prev-day');
  const nextBtn = document.getElementById('next-day');
  const weightInput = document.getElementById('weight-input');
  const saveWeightBtn = document.getElementById('save-weight');
  const weeklyTargetInput = document.getElementById('weekly-target');
  const saveTargetBtn = document.getElementById('save-target');
  const calorieResult = document.getElementById('calorie-result');

  // --- Functions ---
  function saveAll() {
    localStorage.setItem(STORAGE_KEYS.weights, JSON.stringify(weightData));
    localStorage.setItem(STORAGE_KEYS.weeklyTarget, weeklyTarget.toString());
    localStorage.setItem(STORAGE_KEYS.baseCalories, baseCalories.toString());
  }

  function updateDateDisplay() {
    dateDisplay.textContent = selectedDate.toDateString();
  }

  function loadWeightForDate(date) {
    const key = formatDate(date);
    return weightData[key] || null;
  }

  function saveWeightForDate(date, weight) {
    const key = formatDate(date);
    if (weight === null || weight === '') {
      delete weightData[key];
    } else {
      weightData[key] = weight;
    }
    saveAll();
  }

  // Get date n days before
  function getDateNDaysBefore(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() - n);
    return d;
  }

  // Calculate calorie recommendation for selectedDate
  // Rule:
  // If weight 7 days ago = W_old, current weight = W_new,
  // If W_new >= W_old (no loss or gain), reduce calories by 500,
  // If W_new < W_old (weight loss), keep calories same.
  // Calories base is baseCalories.
  // Calories valid for next 7 days after selectedDate.
  function calculateCalories(date) {
    const todayKey = formatDate(date);
    const oldDate = getDateNDaysBefore(date, 7);
    const oldKey = formatDate(oldDate);

    const W_old = weightData[oldKey];
    const W_new = weightData[todayKey];
    const targetLoss = weeklyTarget || 0;

    if (W_old == null || W_new == null) {
      return "Enter weight for today and 7 days ago to calculate calories.";
    }

    // Check if actual loss meets target loss
    const actualLoss = W_old - W_new;

    // Calories start at baseCalories
    let calories = baseCalories;

    // Adjust calories depending on loss
    if (actualLoss < targetLoss) {
      calories -= 500; // reduce by 500 if no sufficient loss
      if (calories < 1200) calories = 1200; // don't go below 1200 cal
      return `Weight loss target not met. Calories reduced by 500 to ${calories} kcal/day for next 7 days.`;
    } else {
      return `Weight loss target met! Maintain ${calories} kcal/day for next 7 days.`;
    }
  }

  // Update UI weight input & calorie text for selectedDate
  function updateUI() {
    updateDateDisplay();
    const weightToday = loadWeightForDate(selectedDate);
    weightInput.value = weightToday !== null ? weightToday : '';

    weeklyTargetInput.value = weeklyTarget !== null ? weeklyTarget : '';

    calorieResult.textContent = calculateCalories(selectedDate);
  }

  // --- Event Listeners ---
  prevBtn.onclick = () => {
    selectedDate.setDate(selectedDate.getDate() - 1);
    updateUI();
  };
  nextBtn.onclick = () => {
    selectedDate.setDate(selectedDate.getDate() + 1);
    updateUI();
  };

  saveWeightBtn.onclick = () => {
    let val = parseFloat(weightInput.value);
    if (isNaN(val) || val <= 0) {
      alert('Please enter a valid weight.');
      return;
    }
    saveWeightForDate(selectedDate, val);
    updateUI();
  };

  saveTargetBtn.onclick = () => {
    let val = parseFloat(weeklyTargetInput.value);
    if (isNaN(val) || val < 0) {
      alert('Please enter a valid target weight loss (>=0).');
      return;
    }
    weeklyTarget = val;
    saveAll();
    updateUI();
  };

  // Init UI on load
  updateUI();
</script>
</body>
</html>
